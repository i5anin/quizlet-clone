<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .approach-inputs input { max-width: 120px; display: inline-block; margin-right: 5px; }
        .approach-inputs { margin-bottom: 0.5rem; }
        textarea { font-size: 0.9rem; }
    </style>
</head>
<body class="p-4">

<h2 class="mb-3">–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>

<form id="workoutForm" class="mb-4">
    <div class="mb-3">
        <label for="date" class="form-label">–î–∞—Ç–∞</label>
        <input type="date" id="date" class="form-control" required>
    </div>

    <div id="exerciseList" class="mb-3"></div>

    <button type="button" class="btn btn-outline-primary" id="addExercise">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
    <button type="submit" class="btn btn-success ms-2">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>

<h4>üìã –¢–µ–∫—É—â–∞—è –±–∞–∑–∞:</h4>
<textarea id="output" rows="12" class="form-control" readonly></textarea>

<script>
    const defaultReps = 15;
    const form = document.getElementById('workoutForm');
    const exerciseList = document.getElementById('exerciseList');
    const output = document.getElementById('output');
    const dateInput = document.getElementById('date');
    const knownExercises = [
        '–°—Ç–∞–Ω–æ–≤–∞—è', '–ì–∏–ø–µ—Ä—Å—Ç–µ–Ω–∑–∏—è', '–ü—Ä–µ—Å—Å —Ç—É—Ä–Ω–∏–∫', '–ì–∞–Ω—Ç–µ–ª—å –ø—Ä–µ–¥–ø–ª–µ—á–∏–µ'
    ];

    let workoutData = JSON.parse(localStorage.getItem('workoutData') || '[]');

    const createExerciseBlock = () => {
        const wrapper = document.createElement('div');
        wrapper.className = 'border p-3 mb-3 rounded bg-light';

        wrapper.innerHTML = `
        <div class="mb-2">
          <input type="text" class="form-control exercise-name" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" list="exerciseList">
          <datalist id="exerciseList">
            ${knownExercises.map(e => `<option value="${e}">`).join('')}
          </datalist>
        </div>
        <div class="approaches"></div>
        <button type="button" class="btn btn-sm btn-outline-secondary add-approach">‚ûï –ü–æ–¥—Ö–æ–¥</button>
      `;

        const approachesDiv = wrapper.querySelector('.approaches');
        const addApproachBtn = wrapper.querySelector('.add-approach');

        const addApproach = () => {
            const group = document.createElement('div');
            group.className = 'approach-inputs';
            group.innerHTML = `
          <input type="number" placeholder="–í–µ—Å (–∫–≥)" class="form-control d-inline weight">
          <input type="number" placeholder="–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è" class="form-control d-inline reps">
        `;
            approachesDiv.appendChild(group);
        };

        addApproachBtn.onclick = addApproach;
        addApproach(); // –¥–æ–±–∞–≤–ª—è–µ–º 1 –ø–æ–¥—Ö–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        exerciseList.appendChild(wrapper);
    };

    document.getElementById('addExercise').onclick = createExerciseBlock;

    form.onsubmit = e => {
        e.preventDefault();

        const date = dateInput.value;
        if (!date) return;

        const entry = { –¥–∞—Ç–∞: date, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: [] };

        [...exerciseList.children].forEach(ex => {
            const name = ex.querySelector('.exercise-name').value.trim();
            if (!name) return;

            const –ø–æ–¥—Ö–æ–¥—ã = [...ex.querySelectorAll('.approach-inputs')].map(row => {
                const –≤–µ—Å = parseFloat(row.querySelector('.weight').value) || null;
                const –ø–æ–≤—Ç–æ—Ä—ã = parseInt(row.querySelector('.reps').value) || (–≤–µ—Å ? defaultReps : null);

                return –≤–µ—Å ? { –≤–µ—Å, –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: –ø–æ–≤—Ç–æ—Ä—ã } : { –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: –ø–æ–≤—Ç–æ—Ä—ã };
            }).filter(p => p.–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è);

            if (–ø–æ–¥—Ö–æ–¥—ã.length > 0) {
                entry.—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.push({ –Ω–∞–∑–≤–∞–Ω–∏–µ: name, –ø–æ–¥—Ö–æ–¥—ã });
                if (!knownExercises.includes(name)) knownExercises.push(name);
            }
        });

        if (!entry.—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.length) return;

        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞–ø–∏—Å—å —Å —Ç–æ–π –∂–µ –¥–∞—Ç–æ–π –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        workoutData = workoutData.filter(rec =>
            !(rec.–¥–∞—Ç–∞ === entry.–¥–∞—Ç–∞ && entry.—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.some(neu =>
                rec.—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.some(old => old.–Ω–∞–∑–≤–∞–Ω–∏–µ === neu.–Ω–∞–∑–≤–∞–Ω–∏–µ)
            ))
        );

        workoutData.push(entry);
        localStorage.setItem('workoutData', JSON.stringify(workoutData, null, 2));
        output.value = JSON.stringify(workoutData, null, 2);
        form.reset();
        exerciseList.innerHTML = '';
    };

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    output.value = JSON.stringify(workoutData, null, 2);
    createExerciseBlock();
</script>

</body>
</html>
